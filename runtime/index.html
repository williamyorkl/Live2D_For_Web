<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=1900">
  <title>TypeScript HTML App</title>
  <style>
    html,
    body {
      margin: 0;
      overflow: hidden;
    }
  </style>
  <script src="./live2dcubismcore.js"></script>
  <script src="./live2d.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wavefile"></script>
</head>

<body>
  <input type="file" id="file-input">
  <div id="audio-level"></div>
</body>
<script>
  let live2dModel
  let lipCount
  let lipCountID
  const lipSyncParams = []
  let live2d = window.live2d.new();



  function generateRandomNumber() {
    const numbers = [0, 0.5, 1];
    const index = Math.floor(Math.random() * numbers.length);
    const selectedNumber = numbers[index];
    numbers.splice(index, 1);
    return selectedNumber;
  }

  // é€‰æ‹©ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶
  const fileInput = document.getElementById("file-input");
  fileInput.addEventListener("change", function () {
    const file = fileInput.files[0];

    // ä½¿ç”¨Web Audio APIè§£ç éŸ³é¢‘æ–‡ä»¶
    const context = new AudioContext();
    const reader = new FileReader();
    reader.onload = function () {
      context.decodeAudioData(reader.result, function (buffer) {
        // åˆ›å»ºåˆ†æžå™¨
        const analyzer = context.createAnalyser();
        analyzer.fftSize = 2048;
        const bufferLength = analyzer.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        // è¿žæŽ¥éŸ³é¢‘æºå’Œåˆ†æžå™¨
        const source = context.createBufferSource();
        source.buffer = buffer;
        source.connect(analyzer);
        analyzer.connect(context.destination);

        // æ¯50msæ›´æ–°éŸ³é¢‘çº§åˆ«å€¼
        setInterval(function () {
          analyzer.getByteFrequencyData(dataArray);
          const average = dataArray.reduce((a, b) => a + b) / bufferLength;
          let audioLevel = average / 100;


          console.log("ðŸš€ ~ file: index.html:58 ~ audioLevel:", audioLevel)

          // TODO - æ·»åŠ æš‚åœé€»è¾‘
          audioLevel = generateRandomNumber() + audioLevel


          lipSyncParams.forEach((item, index) => {
            live2dModel.setParameterValueById(item, audioLevel, 1);
            live2dModel.saveParameters()
            // live2dModel.update()
          });


          document.getElementById("audio-level").innerHTML = `éŸ³é¢‘çº§åˆ«ï¼š${audioLevel.toFixed(2)}%`;

        }, 100);

        // æ’­æ”¾éŸ³é¢‘
        source.start();
      });
    };
    reader.readAsArrayBuffer(file);
  });




  // ç›¸å¯¾ãƒ‘ã‚¹
  const ResourcesPath = './Resources/Haru';

  // ãƒ¢ãƒ‡ãƒ«å®šç¾©---------------------------------------------
  // ãƒ¢ãƒ‡ãƒ«ã‚’é…ç½®ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã®é…åˆ—
  // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã¨model3.jsonã®åå‰ã‚’ä¸€è‡´ã•ã›ã¦ãŠãã“ã¨
  const ModelDir = ['Haru'];


  live2d.init(800, 800);
  live2d.changeModel('20220227toki', ResourcesPath);
  //live2d.setBreathName("PARAM_BREATH");
  live2d.useCustomScale(false);
  live2d.initModel();
  live2d.addListener();
  live2d.run();
  live2d.scale(0.8);
  live2d.setXY(0, 0);
  live2d.setMotionRandom(true);

  console.log("ðŸš€ ~ file: index.html:34 ~ live2d:", live2d)

  setTimeout(() => {
    live2dModel = live2d.delegate._manager._model._model
    lipCount = live2d.delegate._manager._model._modelSetting.getLipSyncParameterCount()
    lipCountID = live2d.delegate._manager._model._modelSetting.getLipSyncParameterId(0)

    console.log("ðŸš€ ~ file: index.html:103 ~ setTimeout ~ live2d:", live2d)
    console.log("ðŸš€ ~ file: index.html:99 ~ setTimeout ~ live2dModel:", live2dModel)
    console.log("ðŸš€ ~ file: index.html:51 ~ setTimeout ~ lipCountID:", lipCountID)
    console.log("ðŸš€ ~ file: index.html:49 ~ lipCount:", lipCount)

    lipSyncParams.push(lipCountID)
  }, 300)
</script>

</html>